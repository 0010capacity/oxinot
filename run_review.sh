#!/bin/bash

# ==============================================================================
# AI Code Review System (oxinot) - Improved Version
# ==============================================================================

# 1. ì„¤ì •
GEMINI_CMD="gemini"
BASE_OUTPUT_DIR="docs/code_reviews"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
OUTPUT_DIR="${BASE_OUTPUT_DIR}/${TIMESTAMP}"
mkdir -p "$OUTPUT_DIR"

# ì»¨í…ìŠ¤íŠ¸ í¬ê¸° ì œí•œ (ëŒ€ëµ ë¬¸ì ìˆ˜, Gemini 2.0 Flash ê¸°ì¤€ ì•½ 1M í† í°)
MAX_CONTEXT_CHARS=800000

# API Rate Limit ë°©ì§€: ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œí•œ
MAX_PARALLEL=3

# ìƒíƒœ ì•„ì´ì½˜
ICON_WAIT="â³"
ICON_DONE="âœ…"
ICON_FAIL="âŒ"
ICON_CHUNK="ğŸ“¦"

# 2. ì—­í•  ë° ì„¸ë¶€ í”„ë¡¬í”„íŠ¸ ì •ì˜
ROLES=(
    "Frontend_UI_UX"
    "Frontend_Editor_Outliner"
    "Frontend_State_Logic"
    "Backend_Rust_Core"
    "Backend_DB_Commands"
    "Security_Infra"
)

# ì—­í• ë³„ íƒ€ê²Ÿ ë””ë ‰í† ë¦¬ ë° í™•ì¥ì ì •ì˜
declare -A TARGETS
declare -A EXTS

TARGETS["Frontend_UI_UX"]="src/components src/styles src/theme"
EXTS["Frontend_UI_UX"]="tsx css ts"

TARGETS["Frontend_Editor_Outliner"]="src/outliner src/editor src/markdown"
EXTS["Frontend_Editor_Outliner"]="tsx ts css"

TARGETS["Frontend_State_Logic"]="src/stores src/hooks src/contexts"
EXTS["Frontend_State_Logic"]="ts tsx"

TARGETS["Backend_Rust_Core"]="src-tauri/src/services src-tauri/src/main.rs src-tauri/src/lib.rs"
EXTS["Backend_Rust_Core"]="rs"

TARGETS["Backend_DB_Commands"]="src-tauri/src/db src-tauri/src/commands src-tauri/src/models"
EXTS["Backend_DB_Commands"]="rs"

# Security_Infra: êµ¬ì²´ì ì¸ íŒŒì¼/í´ë”ë§Œ ì§€ì •
TARGETS["Security_Infra"]="src-tauri/tauri.conf.json src-tauri/capabilities src/tauri-api.ts"
EXTS["Security_Infra"]="json ts"

declare -A PROMPTS
PROMPTS["Frontend_UI_UX"]="
ë‹¹ì‹ ì€ 'UI/UX & Design System Specialist'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ë¦¬ë·° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
## ğŸ¨ UI/UX ì½”ë“œ ë¦¬ë·°

### âš ï¸ ì‹¬ê°ë„ ë†’ìŒ (High Priority)
ëŸ°íƒ€ì„ ì˜¤ë¥˜, UI ê¹¨ì§, ì ‘ê·¼ì„± ìœ„ë°˜ ë“± ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œë§Œ ì´ê³³ì— ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### âš¡ ì‹¬ê°ë„ ì¤‘ê°„ (Medium Priority)
ì„±ëŠ¥ ì €í•˜, ì¼ê´€ì„± ë¶€ì¡±, ìœ ì§€ë³´ìˆ˜ì„± ì €í•˜ ë“± ê°œì„ ì´ ê¶Œì¥ë˜ëŠ” ë¬¸ì œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### ğŸ’¡ ê¸°ì¡´ ì½”ë“œ ê°œì„  ì œì•ˆ (Code Improvements)
í˜„ì¬ ì½”ë“œì˜ ë¦¬íŒ©í† ë§, ìµœì í™”, êµ¬ì¡° ê°œì„  ë“±ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” Before/After ì½”ë“œ ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆ (Feature Suggestions)
í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ ë¶„ì„í•œ ê²°ê³¼, ì‹¤ì œë¡œ ì‚¬ìš©ìì—ê²Œ ê°€ì¹˜ê°€ ìˆì„ ê²ƒ ê°™ì€ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ê¸°ëŠ¥ ì„¤ëª…
- êµ¬í˜„ ë‚œì´ë„ (ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)
- ì˜ˆìƒ íš¨ê³¼ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ , ìƒì‚°ì„± í–¥ìƒ ë“±)

**ì œì•ˆì´ ì—†ë‹¤ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ìƒëµí•˜ê±°ë‚˜ "í˜„ì¬ êµ¬ì¡°ê°€ ì ì ˆí•©ë‹ˆë‹¤"ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.**

[ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸]
ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ë˜, ë¬¸ì œê°€ ìˆëŠ” ê²ƒë§Œ ë¦¬í¬íŠ¸ì— í¬í•¨í•˜ì„¸ìš”:
â–¡ UI êµ¬ì¡° ì•ˆì •ì„±: ë ˆì´ì•„ì›ƒì´ ê¹¨ì§ˆ ìˆ˜ ìˆëŠ” ê²°í•¨ (flex/grid ì˜¤ìš©, ê³ ì • í¬ê¸° ë“±)
â–¡ ìŠ¤íƒ€ì¼ë§ ì¼ê´€ì„±: Magic Numbers ëŒ€ì‹  í…Œë§ˆ ë³€ìˆ˜ ì‚¬ìš© ì—¬ë¶€
â–¡ ë°˜ì‘í˜• ë° ì—£ì§€ ì¼€ì´ìŠ¤: ë‹¤ì–‘í•œ í™”ë©´ í¬ê¸°, ê¸´ í…ìŠ¤íŠ¸ ì²˜ë¦¬
â–¡ ì ‘ê·¼ì„±: aria-label, í¬ì»¤ìŠ¤ë§, í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
â–¡ ì„±ëŠ¥: ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§, ë¹„íš¨ìœ¨ì ì¸ CSS

[ì¤‘ìš” ì§€ì¹¨]
- êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš° 'ê²€í†  í•„ìš”' ë˜ëŠ” 'í™•ì¸ ê¶Œì¥'ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”
- ì—¬ëŸ¬ ì²­í¬ê°€ ìˆëŠ” ê²½ìš°, ì´ì „ ì²­í¬ì—ì„œ ì§€ì í•œ ê²ƒê³¼ ë™ì¼í•œ íŒ¨í„´ì€ 'ì•ì„œ ì–¸ê¸‰í•œ íŒ¨í„´ê³¼ ë™ì¼'ë¡œ ê°„ëµíˆ ì²˜ë¦¬í•˜ì„¸ìš”
"

PROMPTS["Frontend_Editor_Outliner"]="
ë‹¹ì‹ ì€ 'Editor Engine Engineer'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ë¦¬ë·° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
## âœï¸ ì—ë””í„° ì—”ì§„ ì½”ë“œ ë¦¬ë·°

### âš ï¸ ì‹¬ê°ë„ ë†’ìŒ (High Priority)
ë°ì´í„° ì†ì‹¤, í¬ë˜ì‹œ, ì‹¬ê°í•œ ì„±ëŠ¥ ì €í•˜ ë“± ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œë§Œ ì´ê³³ì— ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### âš¡ ì‹¬ê°ë„ ì¤‘ê°„ (Medium Priority)
ë©”ëª¨ë¦¬ ëˆ„ìˆ˜, ë™ê¸°í™” ì´ìŠˆ, ì‚¬ìš©ì„± ì €í•˜ ë“± ê°œì„ ì´ ê¶Œì¥ë˜ëŠ” ë¬¸ì œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### ğŸ’¡ ê¸°ì¡´ ì½”ë“œ ê°œì„  ì œì•ˆ (Code Improvements)
í˜„ì¬ ì—ë””í„° ì½”ë“œì˜ ë¦¬íŒ©í† ë§, ìµœì í™”, êµ¬ì¡° ê°œì„  ë“±ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” Before/After ì½”ë“œ ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆ (Feature Suggestions)
í˜„ì¬ ì—ë””í„° êµ¬ì¡°ë¥¼ ë¶„ì„í•œ ê²°ê³¼, ì‹¤ì œë¡œ ì‚¬ìš©ìì—ê²Œ ê°€ì¹˜ê°€ ìˆì„ ê²ƒ ê°™ì€ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ê¸°ëŠ¥ ì„¤ëª…
- êµ¬í˜„ ë‚œì´ë„ (ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)
- ì˜ˆìƒ íš¨ê³¼ (í¸ì§‘ íš¨ìœ¨, ì•ˆì •ì„± ë“±)

**ì œì•ˆì´ ì—†ë‹¤ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ìƒëµí•˜ê±°ë‚˜ "í˜„ì¬ êµ¬ì¡°ê°€ ì ì ˆí•©ë‹ˆë‹¤"ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.**

[ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸]
ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ë˜, ë¬¸ì œê°€ ìˆëŠ” ê²ƒë§Œ ë¦¬í¬íŠ¸ì— í¬í•¨í•˜ì„¸ìš”:
â–¡ ì„±ëŠ¥ ìµœì í™”: ëŒ€ëŸ‰ ë¸”ë¡ ì²˜ë¦¬ ì‹œ ê°€ìƒí™”, ë Œë”ë§ ë³‘ëª©
â–¡ ìƒíƒœ ë™ê¸°í™”: CodeMirrorì™€ React ìƒíƒœ ê°„ ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±
â–¡ ì•ˆì •ì„±: IME ì…ë ¥(í•œê¸€), ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë“± ë³µì¡í•œ ë™ì‘ì˜ ìƒíƒœ ê´€ë¦¬
â–¡ ë©”ëª¨ë¦¬ ê´€ë¦¬: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•´ì œ ëˆ„ë½, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜
â–¡ ì—ë””í„° UX: ì»¤ì„œ ì´ë™, ì„ íƒ, í¸ì§‘ íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€

[ì¤‘ìš” ì§€ì¹¨]
- êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš° 'ê²€í†  í•„ìš”' ë˜ëŠ” 'í™•ì¸ ê¶Œì¥'ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”
- ì—¬ëŸ¬ ì²­í¬ê°€ ìˆëŠ” ê²½ìš°, ì´ì „ ì²­í¬ì—ì„œ ì§€ì í•œ ê²ƒê³¼ ë™ì¼í•œ íŒ¨í„´ì€ 'ì•ì„œ ì–¸ê¸‰í•œ íŒ¨í„´ê³¼ ë™ì¼'ë¡œ ê°„ëµíˆ ì²˜ë¦¬í•˜ì„¸ìš”
"

PROMPTS["Frontend_State_Logic"]="
ë‹¹ì‹ ì€ 'Frontend Architect'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ë¦¬ë·° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
## ğŸ”„ ìƒíƒœ ê´€ë¦¬ ë° ë¡œì§ ë¦¬ë·°

### âš ï¸ ì‹¬ê°ë„ ë†’ìŒ (High Priority)
ë°ì´í„° ë¶ˆì¼ì¹˜, ê²½ìŸ ìƒíƒœ, ì‹¬ê°í•œ ì„±ëŠ¥ ì €í•˜ ë“± ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œë§Œ ì´ê³³ì— ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### âš¡ ì‹¬ê°ë„ ì¤‘ê°„ (Medium Priority)
ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§, ë³µì¡í•œ ì˜ì¡´ì„±, ê°œì„  ê°€ëŠ¥í•œ êµ¬ì¡° ë“± ê°œì„ ì´ ê¶Œì¥ë˜ëŠ” ë¬¸ì œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### ğŸ’¡ ê¸°ì¡´ ì½”ë“œ ê°œì„  ì œì•ˆ (Code Improvements)
í˜„ì¬ ìƒíƒœ ê´€ë¦¬ ì½”ë“œì˜ ë¦¬íŒ©í† ë§, ìµœì í™”, êµ¬ì¡° ê°œì„  ë“±ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” Before/After ì½”ë“œ ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆ (Feature Suggestions)
í˜„ì¬ ì•„í‚¤í…ì²˜ë¥¼ ë¶„ì„í•œ ê²°ê³¼, ê°œë°œ ê²½í—˜ì´ë‚˜ ì½”ë“œ í’ˆì§ˆì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ê¸°ëŠ¥ ì„¤ëª…
- êµ¬í˜„ ë‚œì´ë„ (ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)
- ì˜ˆìƒ íš¨ê³¼ (ê°œë°œì ê²½í—˜, ìœ ì§€ë³´ìˆ˜ì„± ë“±)

**ì œì•ˆì´ ì—†ë‹¤ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ìƒëµí•˜ê±°ë‚˜ "í˜„ì¬ êµ¬ì¡°ê°€ ì ì ˆí•©ë‹ˆë‹¤"ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.**

[ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸]
ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ë˜, ë¬¸ì œê°€ ìˆëŠ” ê²ƒë§Œ ë¦¬í¬íŠ¸ì— í¬í•¨í•˜ì„¸ìš”:
â–¡ ìƒíƒœ ê´€ë¦¬ ìµœì í™”: Selector ì‚¬ìš©, ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
â–¡ ì»¤ìŠ¤í…€ í›…: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬, ë©”ëª¨ì´ì œì´ì…˜(useMemo, useCallback)
â–¡ ë°ì´í„° ë¬´ê²°ì„±: Race Condition, ì—ëŸ¬ í•¸ë“¤ë§
â–¡ êµ¬ì¡° ë¬¸ì œ: Zombie Child, ìˆœí™˜ ì°¸ì¡°
â–¡ íƒ€ì… ì•ˆì „ì„±: TypeScript í™œìš©ë„

[ì¤‘ìš” ì§€ì¹¨]
- êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš° 'ê²€í†  í•„ìš”' ë˜ëŠ” 'í™•ì¸ ê¶Œì¥'ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”
- ì—¬ëŸ¬ ì²­í¬ê°€ ìˆëŠ” ê²½ìš°, ì´ì „ ì²­í¬ì—ì„œ ì§€ì í•œ ê²ƒê³¼ ë™ì¼í•œ íŒ¨í„´ì€ 'ì•ì„œ ì–¸ê¸‰í•œ íŒ¨í„´ê³¼ ë™ì¼'ë¡œ ê°„ëµíˆ ì²˜ë¦¬í•˜ì„¸ìš”
"

PROMPTS["Backend_Rust_Core"]="
ë‹¹ì‹ ì€ 'Rust Systems Programmer'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ë¦¬ë·° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
## ğŸ¦€ Rust ì½”ì–´ ì‹œìŠ¤í…œ ë¦¬ë·°

### âš ï¸ ì‹¬ê°ë„ ë†’ìŒ (High Priority)
íŒ¨ë‹‰ ê°€ëŠ¥ì„±, ë°ë“œë½, ë°ì´í„° ê²½ìŸ ë“± ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œë§Œ ì´ê³³ì— ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### âš¡ ì‹¬ê°ë„ ì¤‘ê°„ (Medium Priority)
ë¹„íš¨ìœ¨ì ì¸ ë©”ëª¨ë¦¬ ì‚¬ìš©, blocking I/O, ê°œì„  ê°€ëŠ¥í•œ íŒ¨í„´ ë“± ê°œì„ ì´ ê¶Œì¥ë˜ëŠ” ë¬¸ì œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### ğŸ’¡ ê¸°ì¡´ ì½”ë“œ ê°œì„  ì œì•ˆ (Code Improvements)
í˜„ì¬ Rust ì½”ë“œì˜ ë¦¬íŒ©í† ë§, ìµœì í™”, idiomatic íŒ¨í„´ ì ìš© ë“±ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” Before/After ì½”ë“œ ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆ (Feature Suggestions)
í˜„ì¬ ë°±ì—”ë“œ êµ¬ì¡°ë¥¼ ë¶„ì„í•œ ê²°ê³¼, ì‹œìŠ¤í…œ ì•ˆì •ì„±ì´ë‚˜ ìš´ì˜ íš¨ìœ¨ì„±ì„ ë†’ì¼ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ê¸°ëŠ¥ ì„¤ëª…
- êµ¬í˜„ ë‚œì´ë„ (ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)
- ì˜ˆìƒ íš¨ê³¼ (ì•ˆì •ì„±, ì„±ëŠ¥ ë“±)

**ì œì•ˆì´ ì—†ë‹¤ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ìƒëµí•˜ê±°ë‚˜ "í˜„ì¬ êµ¬ì¡°ê°€ ì ì ˆí•©ë‹ˆë‹¤"ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.**

[ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸]
ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ë˜, ë¬¸ì œê°€ ìˆëŠ” ê²ƒë§Œ ë¦¬í¬íŠ¸ì— í¬í•¨í•˜ì„¸ìš”:
â–¡ ì•ˆì „ì„±: unwrap()/expect() ë‚¨ë°œë¡œ ì¸í•œ ëŸ°íƒ€ì„ íŒ¨ë‹‰ ìœ„í—˜
â–¡ ì„±ëŠ¥: async í•¨ìˆ˜ ë‚´ blocking I/O, ë¶ˆí•„ìš”í•œ clone()
â–¡ ë™ì‹œì„±: Mutex/RwLock ì‚¬ìš© ì‹œ ë°ë“œë½ ê°€ëŠ¥ì„±
â–¡ Rust ê´€ìš©êµ¬: idiomatic Rust íŒ¨í„´ ì‚¬ìš© ì—¬ë¶€
â–¡ ì—ëŸ¬ ì²˜ë¦¬: Result/Optionì˜ ì ì ˆí•œ ì‚¬ìš©

[ì¤‘ìš” ì§€ì¹¨]
- êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš° 'ê²€í†  í•„ìš”' ë˜ëŠ” 'í™•ì¸ ê¶Œì¥'ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”
- ì—¬ëŸ¬ ì²­í¬ê°€ ìˆëŠ” ê²½ìš°, ì´ì „ ì²­í¬ì—ì„œ ì§€ì í•œ ê²ƒê³¼ ë™ì¼í•œ íŒ¨í„´ì€ 'ì•ì„œ ì–¸ê¸‰í•œ íŒ¨í„´ê³¼ ë™ì¼'ë¡œ ê°„ëµíˆ ì²˜ë¦¬í•˜ì„¸ìš”
"

PROMPTS["Backend_DB_Commands"]="
ë‹¹ì‹ ì€ 'Database & API Designer'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ë¦¬ë·° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
## ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ & API ë¦¬ë·°

### âš ï¸ ì‹¬ê°ë„ ë†’ìŒ (High Priority)
ë°ì´í„° ì†ì‹¤ ìœ„í—˜, ë³´ì•ˆ ì·¨ì•½ì , ì‹¬ê°í•œ ì„±ëŠ¥ ë¬¸ì œ ë“± ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œë§Œ ì´ê³³ì— ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### âš¡ ì‹¬ê°ë„ ì¤‘ê°„ (Medium Priority)
ì¿¼ë¦¬ ë¹„íš¨ìœ¨, ì…ë ¥ê°’ ê²€ì¦ ë¶€ì¡±, í™•ì¥ì„± ì œí•œ ë“± ê°œì„ ì´ ê¶Œì¥ë˜ëŠ” ë¬¸ì œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### ğŸ’¡ ê¸°ì¡´ ì½”ë“œ ê°œì„  ì œì•ˆ (Code Improvements)
í˜„ì¬ DB/API ì½”ë“œì˜ ë¦¬íŒ©í† ë§, ìµœì í™”, êµ¬ì¡° ê°œì„  ë“±ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” Before/After ì½”ë“œ ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆ (Feature Suggestions)
í˜„ì¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ API êµ¬ì¡°ë¥¼ ë¶„ì„í•œ ê²°ê³¼, ì‹œìŠ¤í…œì„ ë°œì „ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ê¸°ëŠ¥ ì„¤ëª…
- êµ¬í˜„ ë‚œì´ë„ (ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)
- ì˜ˆìƒ íš¨ê³¼ (ì‚¬ìš©ì ê°€ì¹˜, ì„±ëŠ¥ ë“±)

**ì œì•ˆì´ ì—†ë‹¤ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ìƒëµí•˜ê±°ë‚˜ "í˜„ì¬ êµ¬ì¡°ê°€ ì ì ˆí•©ë‹ˆë‹¤"ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.**

[ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸]
ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ë˜, ë¬¸ì œê°€ ìˆëŠ” ê²ƒë§Œ ë¦¬í¬íŠ¸ì— í¬í•¨í•˜ì„¸ìš”:
â–¡ ì¿¼ë¦¬ ìµœì í™”: N+1 ë¬¸ì œ, ì¸ë±ìŠ¤ ëˆ„ë½, ë¹„íš¨ìœ¨ì ì¸ ì¡°íšŒ
â–¡ íŠ¸ëœì­ì…˜: ì›ìì„±ì´ í•„ìš”í•œ ì‘ì—…ì˜ íŠ¸ëœì­ì…˜ ì²˜ë¦¬
â–¡ IPC ì¸í„°í˜ì´ìŠ¤: Tauri Commandì˜ ì…ë ¥ê°’ ê²€ì¦, íƒ€ì… ì•ˆì „ì„±
â–¡ í™•ì¥ì„±: ìŠ¤í‚¤ë§ˆ ë³€ê²½ ìš©ì´ì„±, ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ
â–¡ ë°ì´í„° ë¬´ê²°ì„±: ì œì•½ ì¡°ê±´, ì™¸ë˜ í‚¤, ì¼ê´€ì„±

[ì¤‘ìš” ì§€ì¹¨]
- êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš° 'ê²€í†  í•„ìš”' ë˜ëŠ” 'í™•ì¸ ê¶Œì¥'ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”
- ì—¬ëŸ¬ ì²­í¬ê°€ ìˆëŠ” ê²½ìš°, ì´ì „ ì²­í¬ì—ì„œ ì§€ì í•œ ê²ƒê³¼ ë™ì¼í•œ íŒ¨í„´ì€ 'ì•ì„œ ì–¸ê¸‰í•œ íŒ¨í„´ê³¼ ë™ì¼'ë¡œ ê°„ëµíˆ ì²˜ë¦¬í•˜ì„¸ìš”
"

PROMPTS["Security_Infra"]="
ë‹¹ì‹ ì€ 'Security & Infrastructure Engineer'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ë¦¬ë·° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
## ğŸ”’ ë³´ì•ˆ ë° ì¸í”„ë¼ ë¦¬ë·°

### âš ï¸ ì‹¬ê°ë„ ë†’ìŒ (High Priority)
ë³´ì•ˆ ì·¨ì•½ì , ê³¼ë„í•œ ê¶Œí•œ, ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë“± ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œë§Œ ì´ê³³ì— ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### âš¡ ì‹¬ê°ë„ ì¤‘ê°„ (Medium Priority)
ì„¤ì • ìµœì í™” í•„ìš”, ëª¨ë²” ì‚¬ë¡€ ë¯¸ì ìš© ë“± ê°œì„ ì´ ê¶Œì¥ë˜ëŠ” ë¬¸ì œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì´ ì„¹ì…˜ì„ ìƒëµí•˜ì„¸ìš”.

í˜•ì‹: [íŒŒì¼ëª…:ë¼ì¸] ë¬¸ì œ ì„¤ëª… â†’ í•´ê²° ë°©ë²•

### ğŸ’¡ ê¸°ì¡´ ì„¤ì • ê°œì„  ì œì•ˆ (Configuration Improvements)
í˜„ì¬ ë³´ì•ˆ ì„¤ì • ë° ì¸í”„ë¼ êµ¬ì„±ì˜ ê°œì„  ë°©ì•ˆì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” Before/After ì„¤ì • ì˜ˆì‹œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆ (Feature Suggestions)
í˜„ì¬ ë³´ì•ˆ ì„¤ì •ê³¼ ì¸í”„ë¼ êµ¬ì¡°ë¥¼ ë¶„ì„í•œ ê²°ê³¼, ë³´ì•ˆì„ ê°•í™”í•˜ê±°ë‚˜ ìš´ì˜ì„ ê°œì„ í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ê° ì œì•ˆì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ê¸°ëŠ¥ ì„¤ëª…
- êµ¬í˜„ ë‚œì´ë„ (ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)
- ì˜ˆìƒ íš¨ê³¼ (ë³´ì•ˆ ê°•í™”, ìš´ì˜ íš¨ìœ¨ ë“±)

**ì œì•ˆì´ ì—†ë‹¤ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ìƒëµí•˜ê±°ë‚˜ "í˜„ì¬ ì„¤ì •ì´ ì ì ˆí•©ë‹ˆë‹¤"ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.**

[ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸]
ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ë˜, ë¬¸ì œê°€ ìˆëŠ” ê²ƒë§Œ ë¦¬í¬íŠ¸ì— í¬í•¨í•˜ì„¸ìš”:
â–¡ ë³´ì•ˆ ì„¤ì •: Tauri capabilities ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì¤€ìˆ˜
â–¡ ì…ë ¥ê°’ ê²€ì¦: XSS, ì¸ì ì…˜ ë“± ì·¨ì•½ì  ë°©ì–´
â–¡ ì„¤ì • ìµœì í™”: tauri.conf.json ë° ë¹Œë“œ ì„¤ì •ì˜ ë³´ì•ˆì„±
â–¡ ë¯¼ê° ì •ë³´: í•˜ë“œì½”ë”©ëœ ë¹„ë°€ í‚¤, ê²½ë¡œ, API í‚¤
â–¡ ê¶Œí•œ ê´€ë¦¬: íŒŒì¼ ì‹œìŠ¤í…œ, ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ê¶Œí•œ

[ì¤‘ìš” ì§€ì¹¨]
- êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš° 'ê²€í†  í•„ìš”' ë˜ëŠ” 'í™•ì¸ ê¶Œì¥'ìœ¼ë¡œ í‘œì‹œí•˜ì„¸ìš”
- ì—¬ëŸ¬ ì²­í¬ê°€ ìˆëŠ” ê²½ìš°, ì´ì „ ì²­í¬ì—ì„œ ì§€ì í•œ ê²ƒê³¼ ë™ì¼í•œ íŒ¨í„´ì€ 'ì•ì„œ ì–¸ê¸‰í•œ íŒ¨í„´ê³¼ ë™ì¼'ë¡œ ê°„ëµíˆ ì²˜ë¦¬í•˜ì„¸ìš”
"

# 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

# Gemini CLI ì¡´ì¬ í™•ì¸
check_gemini_cli() {
    if ! command -v "$GEMINI_CMD" &> /dev/null; then
        echo "âŒ ì˜¤ë¥˜: Gemini CLIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        echo "   ì„¤ì¹˜: npm install -g @google/generative-ai"
        exit 1
    fi
}

# íŒŒì¼ ìˆ˜ì§‘ í•¨ìˆ˜
collect_files() {
    local role=$1
    local targets="${TARGETS[$role]}"
    local exts="${EXTS[$role]}"
    local files=()

    for dir in $targets; do
        if [ ! -d "$dir" ] && [ ! -f "$dir" ]; then
            continue
        fi

        for ext in $exts; do
            while IFS= read -r -d '' file; do
                # Security_Infra íŠ¹ìˆ˜ ì¼€ì´ìŠ¤
                if [ "$role" == "Security_Infra" ]; then
                    if [[ "$file" != *"tauri.conf.json"* && \
                          "$file" != *"tauri-api.ts"* && \
                          "$file" != *"capabilities"* ]]; then
                        continue
                    fi
                fi
                files+=("$file")
            done < <(find "$dir" -name "*.$ext" -type f \
                -not -path "*/node_modules/*" \
                -not -path "*/dist/*" \
                -not -path "*/target/*" \
                -not -path "*/.git/*" \
                -print0 2>/dev/null)
        done
    done

    printf '%s\n' "${files[@]}"
}

# íŒŒì¼ì„ ì²­í¬ë¡œ ë¶„í• 
create_chunks() {
    local role=$1
    local -n files_ref=$2
    local chunks=()
    local current_chunk=()
    local current_size=0

    for file in "${files_ref[@]}"; do
        if [ ! -f "$file" ]; then
            continue
        fi

        local file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)

        # ë‹¨ì¼ íŒŒì¼ì´ ì œí•œì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš°
        if [ "$file_size" -gt "$MAX_CONTEXT_CHARS" ]; then
            echo "âš ï¸  ê²½ê³ : $file íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ ($(($file_size / 1024))KB). ê±´ë„ˆëœë‹ˆë‹¤." >&2
            continue
        fi

        # í˜„ì¬ ì²­í¬ì— ì¶”ê°€í–ˆì„ ë•Œ ì œí•œ ì´ˆê³¼ ì—¬ë¶€ í™•ì¸
        if [ $((current_size + file_size)) -gt "$MAX_CONTEXT_CHARS" ] && [ ${#current_chunk[@]} -gt 0 ]; then
            # í˜„ì¬ ì²­í¬ ì €ì¥
            chunks+=("$(IFS=,; echo "${current_chunk[*]}")")
            current_chunk=()
            current_size=0
        fi

        current_chunk+=("$file")
        current_size=$((current_size + file_size))
    done

    # ë§ˆì§€ë§‰ ì²­í¬ ì €ì¥
    if [ ${#current_chunk[@]} -gt 0 ]; then
        chunks+=("$(IFS=,; echo "${current_chunk[*]}")")
    fi

    printf '%s\n' "${chunks[@]}"
}

# í”„ë¡œì íŠ¸ êµ¬ì¡° ìƒì„± (í•œ ë²ˆë§Œ)
generate_project_structure() {
    if [ -f "$OUTPUT_DIR/project_structure.txt" ]; then
        cat "$OUTPUT_DIR/project_structure.txt"
        return
    fi

    local structure=""

    # tree ëª…ë ¹ì–´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
    if command -v tree &> /dev/null; then
        structure=$(tree -L 3 -I 'node_modules|dist|target|.git' --charset ascii)
    else
        # tree ì—†ìœ¼ë©´ findë¡œ ëŒ€ì²´
        structure=$(find . -maxdepth 3 -type d \
            -not -path "*/node_modules/*" \
            -not -path "*/dist/*" \
            -not -path "*/target/*" \
            -not -path "*/.git/*" \
            2>/dev/null | sort)
    fi

    echo "$structure" > "$OUTPUT_DIR/project_structure.txt"
    echo "$structure"
}

# ì»¨í…ìŠ¤íŠ¸ ìƒì„±
build_context() {
    local -n chunk_files=$1
    local role=$2
    local chunk_num=$3
    local total_chunks=$4
    local context=""

    # í”„ë¡œì íŠ¸ êµ¬ì¡° ì¶”ê°€ (ì²« ë²ˆì§¸ ì²­í¬ì—ë§Œ)
    if [ "$chunk_num" -eq 0 ]; then
        context+=$'\n'
        context+="[í”„ë¡œì íŠ¸ ì „ì²´ êµ¬ì¡°]"
        context+=$'\n'
        context+=$(generate_project_structure)
        context+=$'\n\n'
    fi

    # ì²­í¬ ì •ë³´
    context+="[í˜„ì¬ ì²­í¬ ì •ë³´]"
    context+=$'\n'
    context+="ì²­í¬ $((chunk_num + 1))/$total_chunks"
    context+=$'\n'
    context+="ì´ ì²­í¬ì— í¬í•¨ëœ íŒŒì¼: ${#chunk_files[@]}ê°œ"
    context+=$'\n\n'

    # íŒŒì¼ ë‚´ìš©
    context+="[ì†ŒìŠ¤ ì½”ë“œ]"
    context+=$'\n'
    for file in "${chunk_files[@]}"; do
        if [ ! -f "$file" ]; then
            continue
        fi

        context+=$'\n'
        context+="--- FILE START: $file ---"
        context+=$'\n'
        context+=$(cat "$file" 2>/dev/null || echo "# íŒŒì¼ ì½ê¸° ì‹¤íŒ¨")
        context+=$'\n'
        context+="--- FILE END: $file ---"
        context+=$'\n'
    done

    echo "$context"
}

# 4. ë³‘ë ¬ ì‹¤í–‰ ê´€ë¦¬
declare -A PIDS
declare -A STATUS
running_jobs=0

# ì´ˆê¸° ìƒíƒœ ì„¤ì •
for role in "${ROLES[@]}"; do
    STATUS[$role]="$ICON_WAIT ëŒ€ê¸° ì¤‘..."
done

# í™”ë©´ ì¶œë ¥ í•¨ìˆ˜
draw_status() {
    tput cuu $((${#ROLES[@]} + 1))
    echo "ğŸ”„ ì§„í–‰ ìƒí™© (ì‹¤í–‰ ì¤‘: $running_jobs/$MAX_PARALLEL)"
    for role in "${ROLES[@]}"; do
        tput el
        printf "  %-30s : %s\n" "$role" "${STATUS[$role]}"
    done
}

# í™”ë©´ ì´ˆê¸°í™”
tput civis
clear

echo "ğŸš€ [Start] AI ì½”ë“œ ë¦¬ë·°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
echo "ğŸ“‚ ì €ì¥ ê²½ë¡œ: $OUTPUT_DIR"
echo ""

# Gemini CLI í™•ì¸
check_gemini_cli

# 5. ì‘ì—… ì‹¤í–‰
echo "ğŸ” íŒŒì¼ ìˆ˜ì§‘ ì¤‘..."
declare -A ALL_FILES
declare -A ALL_CHUNKS

for role in "${ROLES[@]}"; do
    mapfile -t files < <(collect_files "$role")
    ALL_FILES[$role]="${files[*]}"

    if [ ${#files[@]} -eq 0 ]; then
        STATUS[$role]="âš ï¸  íŒŒì¼ ì—†ìŒ"
        continue
    fi

    mapfile -t chunks < <(create_chunks "$role" files)
    ALL_CHUNKS[$role]="${#chunks[@]}"

    echo "  $role: ${#files[@]}ê°œ íŒŒì¼, ${#chunks[@]}ê°œ ì²­í¬"
done

echo ""
echo "ğŸ“ ë¦¬ë·° ì‘ì„± ì‹œì‘..."
echo ""

# ìµœì´ˆ ê³µê°„ í™•ë³´
for role in "${ROLES[@]}"; do echo ""; done

# ëª¨ë“  ì‘ì—… í
job_queue=()
for role in "${ROLES[@]}"; do
    files_str="${ALL_FILES[$role]}"
    if [ -z "$files_str" ]; then
        continue
    fi

    IFS=' ' read -ra files <<< "$files_str"
    mapfile -t chunks < <(create_chunks "$role" files)

    for i in "${!chunks[@]}"; do
        job_queue+=("$role|$i|${chunks[$i]}")
    done
done

# ì‘ì—… ì²˜ë¦¬
job_index=0
while [ $job_index -lt ${#job_queue[@]} ] || [ $running_jobs -gt 0 ]; do
    # ìƒˆ ì‘ì—… ì‹œì‘
    while [ $running_jobs -lt $MAX_PARALLEL ] && [ $job_index -lt ${#job_queue[@]} ]; do
        job="${job_queue[$job_index]}"
        IFS='|' read -r role chunk_num chunk_files_str <<< "$job"

        IFS=',' read -ra chunk_files <<< "$chunk_files_str"
        total_chunks="${ALL_CHUNKS[$role]}"

        if [ "$total_chunks" -gt 1 ]; then
            filename="${OUTPUT_DIR}/${role}_part$((chunk_num + 1))of${total_chunks}.md"
            STATUS[$role]="$ICON_CHUNK ì²­í¬ $((chunk_num + 1))/$total_chunks ì‘ì„± ì¤‘..."
        else
            filename="${OUTPUT_DIR}/${role}.md"
            STATUS[$role]="$ICON_WAIT ì‘ì„± ì¤‘..."
        fi

        (
            context=$(build_context chunk_files "$role" "$chunk_num" "$total_chunks")
            prompt="${PROMPTS[$role]}"
            final_prompt="$prompt"$'\n\n'"=== SOURCE CODE CONTEXT ===$context"

            $GEMINI_CMD "$final_prompt" > "$filename" 2>&1
            exit_code=$?

            # ì²­í¬ ì •ë³´ íŒŒì¼ ì €ì¥
            if [ $exit_code -eq 0 ]; then
                {
                    echo "# ì²­í¬ ì •ë³´"
                    echo "ì²­í¬ ë²ˆí˜¸: $((chunk_num + 1))/$total_chunks"
                    echo "íŒŒì¼ ëª©ë¡:"
                    printf '- %s\n' "${chunk_files[@]}"
                } >> "$filename"
            fi

            exit $exit_code
        ) &

        PIDS["${role}_${chunk_num}"]=$!
        running_jobs=$((running_jobs + 1))
        job_index=$((job_index + 1))
        draw_status
    done

    # ì™„ë£Œëœ ì‘ì—… í™•ì¸
    for key in "${!PIDS[@]}"; do
        pid=${PIDS[$key]}
        if ! kill -0 "$pid" 2>/dev/null; then
            wait "$pid"
            exit_code=$?

            IFS='_' read -r role chunk_num <<< "$key"
            total_chunks="${ALL_CHUNKS[$role]}"

            if [ $exit_code -eq 0 ]; then
                if [ "$total_chunks" -gt 1 ]; then
                    # ëª¨ë“  ì²­í¬ ì™„ë£Œ í™•ì¸
                    all_done=true
                    for ((i=0; i<total_chunks; i++)); do
                        if kill -0 "${PIDS[${role}_${i}]}" 2>/dev/null; then
                            all_done=false
                            break
                        fi
                    done
                    if [ "$all_done" = true ]; then
                        STATUS[$role]="$ICON_DONE ì™„ë£Œ (${total_chunks}ê°œ ì²­í¬)"
                    fi
                else
                    STATUS[$role]="$ICON_DONE ì™„ë£Œ"
                fi
            else
                STATUS[$role]="$ICON_FAIL ì‹¤íŒ¨ (Code: $exit_code)"
            fi

            unset PIDS[$key]
            running_jobs=$((running_jobs - 1))
            draw_status
        fi
    done

    sleep 0.5
done

# 6. ë§ˆë¬´ë¦¬
tput cnorm
echo ""
echo "ğŸ‰ ëª¨ë“  ë¦¬ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "ğŸ“„ ê²°ê³¼ í™•ì¸: $OUTPUT_DIR"
echo ""
echo "ğŸ“Š ìš”ì•½:"
for role in "${ROLES[@]}"; do
    echo "  - $role: ${STATUS[$role]}"
done
