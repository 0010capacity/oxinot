name: Required Checks

on:
  pull_request:
    branches:
      - main
  merge_group:

permissions:
  contents: read

concurrency:
  group: required-checks-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  required:
    name: required
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine whether CI is required for this change
        id: classify
        shell: bash
        run: |
          set -euo pipefail

          # For merge_group, we don't have a PR diff available in the same way.
          # In that case, require CI by default.
          if [ "${{ github.event_name }}" = "merge_group" ]; then
            echo "ci_required=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # PR case: diff base...head.
          git fetch origin "${{ github.base_ref }}" --depth=1

          FILES="$(git diff --name-only "origin/${{ github.base_ref }}...HEAD" || true)"

          # If no files found, be conservative and require CI.
          if [ -z "${FILES}" ]; then
            echo "ci_required=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Any file outside these paths means CI is required.
          # Allowed (no CI):
          # - docs/**
          # - any *.md (includes README.md)
          # - .github/**
          # - .changeset/**
          NON_ALLOWED="$(printf "%s\n" "${FILES}" | grep -Ev '^(docs/|\.github/|\.changeset/|.*\.md$)' || true)"

          if [ -n "${NON_ALLOWED}" ]; then
            echo "ci_required=true" >> "$GITHUB_OUTPUT"
            echo "Non-doc/config/changeset files detected; CI required:"
            echo "${NON_ALLOWED}"
          else
            echo "ci_required=false" >> "$GITHUB_OUTPUT"
            echo "Docs/config/changeset-only change; CI not required."
          fi

      - name: Wait for CI workflow run when required
        if: steps.classify.outputs.ci_required == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          # `gh pr checks --required` can fail when the repository ruleset required-check list
          # does not include any checks yet (or when the checks have not been reported).
          #
          # Instead, poll the CI workflow run for this PR head SHA and require it to succeed.
          OWNER_REPO="${{ github.repository }}"
          OWNER="${OWNER_REPO%%/*}"
          REPO="${OWNER_REPO#*/}"
          SHA="${{ github.event.pull_request.head.sha }}"

          echo "Waiting for CI workflow run (name: CI) on SHA: ${SHA}"

          # Poll for up to 30 minutes (180 * 10s).
          for i in $(seq 1 180); do
            # Use gh's JSON output (no jq dependency).
            # Find the latest run for this head SHA where the workflow name is "CI".
            RUN_LINE="$(
              gh run list \
                --repo "${OWNER_REPO}" \
                --event pull_request \
                --json databaseId,headSha,name,status,conclusion,url \
                --jq ".[] | select(.headSha==\"${SHA}\" and .name==\"CI\") | \"\\(.databaseId)\\t\\(.status)\\t\\(.conclusion)\\t\\(.url)\"" \
                | head -n 1
            )"

            if [ -z "${RUN_LINE}" ]; then
              echo "CI run not found yet (attempt ${i}/180)."
              sleep 10
              continue
            fi

            RUN_ID="$(printf "%s" "${RUN_LINE}" | cut -f1)"
            RUN_STATUS="$(printf "%s" "${RUN_LINE}" | cut -f2)"
            RUN_CONCLUSION="$(printf "%s" "${RUN_LINE}" | cut -f3)"
            RUN_URL="$(printf "%s" "${RUN_LINE}" | cut -f4)"

            echo "CI run: ${RUN_URL} (status=${RUN_STATUS}, conclusion=${RUN_CONCLUSION})"

            if [ "${RUN_STATUS}" = "completed" ]; then
              if [ "${RUN_CONCLUSION}" = "success" ]; then
                echo "CI succeeded."
                exit 0
              fi

              echo "CI did not succeed (conclusion=${RUN_CONCLUSION})."
              exit 1
            fi

            # Not completed yet; wait.
            sleep 10
          done

          echo "Timed out waiting for CI workflow run."
          exit 1

      - name: Merge group requires CI (guardrail)
        if: steps.classify.outputs.ci_required == 'true' && github.event_name == 'merge_group'
        shell: bash
        run: |
          echo "This repository requires CI for merge queue events."
          echo "If you're using GitHub merge queue, ensure the CI workflow runs on merge_group too."
          exit 1

      - name: Done
        shell: bash
        run: echo "required checks passed"
