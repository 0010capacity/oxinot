name: Required Checks

on:
  pull_request:
    branches:
      - main
  merge_group:

permissions:
  contents: read

concurrency:
  group: required-checks-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  required:
    name: required
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine whether CI is required for this change
        id: classify
        shell: bash
        run: |
          set -euo pipefail

          # For merge_group, we don't have a PR diff available in the same way.
          # In that case, require CI by default.
          if [ "${{ github.event_name }}" = "merge_group" ]; then
            echo "ci_required=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # PR case: diff base...head.
          git fetch origin "${{ github.base_ref }}" --depth=1

          FILES="$(git diff --name-only "origin/${{ github.base_ref }}...HEAD" || true)"

          # If no files found, be conservative and require CI.
          if [ -z "${FILES}" ]; then
            echo "ci_required=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Any file outside these paths means CI is required.
          # Allowed (no CI):
          # - docs/**
          # - any *.md (includes README.md)
          # - .github/**
          # - .changeset/**
          NON_ALLOWED="$(printf "%s\n" "${FILES}" | grep -Ev '^(docs/|\.github/|\.changeset/|.*\.md$)' || true)"

          if [ -n "${NON_ALLOWED}" ]; then
            echo "ci_required=true" >> "$GITHUB_OUTPUT"
            echo "Non-doc/config/changeset files detected; CI required:"
            echo "${NON_ALLOWED}"
          else
            echo "ci_required=false" >> "$GITHUB_OUTPUT"
            echo "Docs/config/changeset-only change; CI not required."
          fi

      - name: Wait for CI (lint-and-build) when required
        if: steps.classify.outputs.ci_required == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          # We intentionally wait for the CI *job status check* name "lint-and-build",
          # so that the required gating here reflects the same signal you care about.
          gh pr checks "${{ github.event.pull_request.number }}" --watch --required

      - name: Merge group requires CI (guardrail)
        if: steps.classify.outputs.ci_required == 'true' && github.event_name == 'merge_group'
        shell: bash
        run: |
          echo "This repository requires CI for merge queue events."
          echo "If you're using GitHub merge queue, ensure the CI workflow runs on merge_group too."
          exit 1

      - name: Done
        shell: bash
        run: echo "required checks passed"
