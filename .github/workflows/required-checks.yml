name: Required Checks

on:
  pull_request_target:
    branches:
      - main
  merge_group:

permissions:
  contents: read

concurrency:
  group: required-checks-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  required:
    name: required
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow run
        if: github.event_name == 'pull_request_target'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          # Read shared ignore regex (kept in sync with CI's short-circuit behavior)
          IGNORE_REGEX="$(cat .github/ci/ignore-regex.txt)"
          echo "Loaded ignore regex: ${IGNORE_REGEX}"

          # Poll the CI workflow run for this PR head SHA and require it to succeed.
          OWNER_REPO="${{ github.repository }}"
          SHA="${{ github.event.pull_request.head.sha }}"

          echo "Waiting for CI workflow run (name: CI) on SHA: ${SHA}"

          # Poll for up to 30 minutes (180 * 10s).
          for i in $(seq 1 180); do
            RUN_LINE="$(
              gh run list \
                --repo "${OWNER_REPO}" \
                --event pull_request \
                --json databaseId,headSha,name,status,conclusion,url \
                --jq ".[] | select(.headSha==\"${SHA}\" and .name==\"CI\") | \"\(.databaseId)\t\(.status)\t\(.conclusion)\t\(.url)\"" \
                | head -n 1
            )"

            if [ -z "${RUN_LINE}" ]; then
              echo "CI run not found yet (attempt ${i}/180)."
              sleep 10
              continue
            fi

            RUN_STATUS="$(printf "%s" "${RUN_LINE}" | cut -f2)"
            RUN_CONCLUSION="$(printf "%s" "${RUN_LINE}" | cut -f3)"
            RUN_URL="$(printf "%s" "${RUN_LINE}" | cut -f4)"

            echo "CI run: ${RUN_URL} (status=${RUN_STATUS}, conclusion=${RUN_CONCLUSION})"

            if [ "${RUN_STATUS}" = "completed" ]; then
              if [ "${RUN_CONCLUSION}" = "success" ]; then
                echo "CI succeeded."
                exit 0
              fi

              echo "CI did not succeed (conclusion=${RUN_CONCLUSION})."
              exit 1
            fi

            sleep 10
          done

          echo "Timed out waiting for CI workflow run."
          exit 1

      - name: Merge group requires CI (guardrail)
        if: github.event_name == 'merge_group'
        shell: bash
        run: |
          echo "This repository requires CI for merge queue events."
          echo "Ensure the CI workflow runs and is required for merge_group too."
          exit 1

      - name: Done
        shell: bash
        run: echo "required checks passed"
