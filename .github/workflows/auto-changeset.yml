name: Auto Changeset

on:
  workflow_run:
    workflows: ["CI"]
    branches: ["main"]
    types:
      - completed
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: changeset-generation
  cancel-in-progress: false

jobs:
  # Step 1: Generate changeset files and create PR for new commits
  auto-changeset:
    name: Generate Changeset PR
    # Only run when CI succeeded on main
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Check if we should skip changeset generation
        id: check_skip
        run: |
          set -euo pipefail

          # Get the last commit message and author
          LAST_COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          LAST_COMMIT_AUTHOR=$(git log -1 --pretty=%an)

          # Skip if last commit is from github-actions bot
          if [[ "$LAST_COMMIT_AUTHOR" == "github-actions[bot]" ]]; then
            echo "Last commit is workflow-generated - skipping to prevent infinite loop"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Always generate changeset for new commits
          # Pending changesets will accumulate and be processed by the Version Packages PR
          echo "Will generate changeset for new commits"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Generate Changeset
        if: steps.check_skip.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Generate changeset file based on commit messages
          npm run changeset:auto

          # Check if any changeset file was created (including untracked files)
          if git status --porcelain | grep -q ".changeset/"; then
            echo "changeset_generated=true" >> "$GITHUB_ENV"
          else
            echo "changeset_generated=false" >> "$GITHUB_ENV"
          fi

      - name: Skip changeset PR creation (workflow-generated commits only)
        if: steps.check_skip.outputs.skip == 'true'
        run: |
          echo "No changeset needed - last commit is from github-actions bot"

      - name: Create or Update PR
        if: steps.check_skip.outputs.skip == 'false' && env.changeset_generated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if changeset PR already exists
          EXISTING_PR=$(gh pr list \
            --base main \
            --head "changeset-auto" \
            --state open \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            # Update existing PR
            echo "Updating existing changeset PR #$EXISTING_PR"
            git checkout changeset-auto
            git pull origin changeset-auto
            git add .changeset

            # Check if there are actual changes
            if git diff --cached --quiet; then
              echo "No new changes to commit"
              exit 0
            fi

            # Create a new commit instead of amending
            git commit -m "chore: update auto-generated changeset"
            git push origin changeset-auto
          else
            # Create new branch and PR
            echo "Creating new changeset PR"
            git checkout -b changeset-auto
            git add .changeset
            git commit -m "chore: auto-generate changeset"
            git push origin changeset-auto --force

            gh pr create \
              --title "chore: auto-generate changeset" \
              --body "This PR was automatically generated by the Auto Changeset workflow. It contains version bumps and changelog updates based on recent commits. Please review and merge to publish a new release." \
              --base main \
              --head changeset-auto \
              --label "automated"
           fi

  create-version-packages-pr:
    name: Create Version Packages PR
    if: >
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changesets in this push
        id: check_changesets
        run: |
          set -euo pipefail

          CHANGED_FILES=""
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git show --name-only --pretty="" ${{ github.sha }})
          fi

          HAS_CHANGESET_FILES=$(echo "$CHANGED_FILES" | grep -E "\.changeset/[^/]+\.md$" | grep -v README.md | wc -l || true)

          if [ "$HAS_CHANGESET_FILES" -gt 0 ]; then
            echo "has_changesets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changesets=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if no changesets
        if: steps.check_changesets.outputs.has_changesets == 'false'
        run: echo "No changeset files were added in this push - skipping Version Packages PR creation"

      - name: Setup Node
        if: steps.check_changesets.outputs.has_changesets == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: Install dependencies
        if: steps.check_changesets.outputs.has_changesets == 'true'
        run: npm install

      - name: Create Version Packages PR
        if: steps.check_changesets.outputs.has_changesets == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          npm run version

          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "chore: version packages"
            git push origin main

            BRANCH_NAME="changeset-release/main"
            
            if git rev-parse "origin/$BRANCH_NAME" >/dev/null 2>&1; then
              git checkout "$BRANCH_NAME"
              git pull origin "$BRANCH_NAME"
              git merge main --no-edit
              git push origin "$BRANCH_NAME"
              echo "Updated existing release branch"
            else
              git checkout -b "$BRANCH_NAME"
              git push origin "$BRANCH_NAME" -u
              
              gh pr create \
                --title "chore: version packages" \
                --body "This PR updates version numbers and generates changelogs based on changesets." \
                --base main \
                --head "$BRANCH_NAME" \
                --label "automated"
            fi
          else
            echo "No changes after version update"
          fi
