name: Auto Changeset

on:
  workflow_run:
    workflows: ["CI"]
    branches: ["main"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-changeset-main
  cancel-in-progress: false

jobs:
  auto-changeset:
    name: auto-changeset
    # Only run when CI succeeded on main
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Check if we should skip changeset generation
        id: check_skip
        run: |
          set -euo pipefail

          # Get the last commit message and author
          LAST_COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          LAST_COMMIT_AUTHOR=$(git log -1 --pretty=%an)

          # If the last commit is "chore: auto-generate changeset" from github-actions bot,
          # skip generating another changeset to prevent infinite loop
          if [[ "$LAST_COMMIT_AUTHOR" == "github-actions[bot]" ]] && \
             [[ "$LAST_COMMIT_MESSAGE" == *"chore: auto-generate changeset"* ]]; then
            echo "Last commit is workflow-generated - skipping to prevent infinite loop"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Changeset
        if: steps.check_skip.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Generate changeset file based on commit messages
          npm run changeset:auto

          # Check if any changeset file was created (including untracked files)
          if git status --porcelain | grep -q ".changeset/"; then
            echo "changeset_generated=true" >> "$GITHUB_ENV"
          else
            echo "changeset_generated=false" >> "$GITHUB_ENV"
          fi

      - name: Skip changeset PR creation (workflow-generated commits only)
        if: steps.check_skip.outputs.skip == 'true'
        run: |
          echo "No changeset needed - only workflow-generated commits since last release"

      - name: Create or Update PR
        if: steps.check_skip.outputs.skip == 'false' && env.changeset_generated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if changeset PR already exists
          EXISTING_PR=$(gh pr list \
            --base main \
            --head "changeset-auto" \
            --state open \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            # Update existing PR
            echo "Updating existing changeset PR #$EXISTING_PR"
            git checkout changeset-auto
            git pull origin changeset-auto
            git add .changeset
            git commit --amend --no-edit || true
            git push origin changeset-auto --force-with-lease
          else
            # Create new branch and PR
            echo "Creating new changeset PR"
            git checkout -b changeset-auto
            git add .changeset
            git commit -m "chore: auto-generate changeset"
            git push origin changeset-auto --force

            gh pr create \
              --title "chore: auto-generate changeset" \
              --body "This PR was automatically generated by the Auto Changeset workflow. It contains version bumps and changelog updates based on recent commits. Please review and merge to publish a new release." \
              --base main \
              --head changeset-auto \
              --label "automated"
          fi
